<!DOCTYPE html>
<head>
    <title>Test Game</title>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://sisudurvsaphfhvctgeb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpc3VkdXJ2c2FwaGZodmN0Z2ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUxOTAzMDQsImV4cCI6MjA2MDc2NjMwNH0.kQWBC2hf8nzP9jOHMiz0yeW2GLlzgd_9tDTzoTZobAw';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Attach sign-up and sign-in to the buttons using form inputs
        window.signUp = async function signUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const { error } = await supabase.auth.signUp({ email, password });
            if (error) {
                console.error("Error signing up:", error.message);
            } else {
                console.log("Sign up successful!");
                window.location.href = "/index.html";
                checkUserStatus(); // Refresh user status
            }
        }
        window.signIn = async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                console.error("Error signing in:", error.message);
            } else {
                console.log("Sign in successful!");
                checkUserStatus(); // Refresh user status
            }
        }

        window.signOut = async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Error signing out:", error.message);
            } else {
                console.log("Sign out successful!");
                checkUserStatus(); // Refresh user status
            }
        }

        // Function to check the current user and update UI
        async function checkUserStatus() {
            const { data: { user } } = await supabase.auth.getUser();
            const statusText = document.getElementById("userStatus");

            if (user) {
                console.log("User is signed in:", user);
                statusText.innerText = `Signed in as: ${user.email}`;
            } else {
                console.log("No user signed in.");
                statusText.innerText = "Not signed in";
            }
        }

        // Run checkUserStatus on page load
        document.addEventListener("DOMContentLoaded", checkUserStatus);

        async function getCurrentUser() {
            const { data: { user } } = await supabase.auth.getUser()
            return user;
        }

        async function getLeaderboard() {
            const { data, error } = await supabase
                .from('Leaderboard')
                .select('*')
                .order('score', { ascending: false });

            if (error) {
                console.error('Error fetching leaderboard:', error);
                return [];
            }
            return data;
        }

       async function addScore(username, score) {

            const { data, error } = await supabase
                .from('Leaderboard')
                .insert([{ username, score }]);

            if (error) {
                console.error('Error adding score:', error);
            } else {
                console.log("Score added successfully!");
                displayLeaderboard();// Refresh the leaderboard
            }
        }

        async function updateScore(username, newScore) {

            const { data, error } = await supabase
                .from('Leaderboard')
                .update({ score: newScore })
                .eq('username', username);

            if (error) {
                console.error('Error updating score:', error);
            } else {
                displayLeaderboard();// Refresh the leaderboard
            }
        }

        async function displayLeaderboard() {
            const leaderboardData = await supabase
                .from('Leaderboard')
                .select('*')
                .order('score', { ascending: false });

            console.log('Leaderboard Data:', leaderboardData); // Debugging line
            if (!leaderboardData || !leaderboardData.data) {
                console.error('Leaderboard data is null or undefined.');
                return; // Exit the function early to avoid further errors
            }

            const leaderboardTable = document.getElementById('Leaderboard');
            leaderboardTable.innerHTML = '';

            // Create table header
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>Rank</th><th>Username</th><th>Score</th>';
            leaderboardTable.appendChild(headerRow);

            // Populate table rows
            leaderboardData.data.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${index + 1}</td><td>${entry.username}</td><td>${entry.score}</td>`;
                leaderboardTable.appendChild(row);
            });
        }

        const addScoreForm = document.getElementById('addScoreForm');
        addScoreForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent page reload
            const username = document.getElementById('username').value;
            const score = parseInt(document.getElementById('score').value, 10);

            await addScore(username, score); // Add the score to the database
            addScoreForm.reset(); // Clear the form
        });

        window.displayLeaderboard = displayLeaderboard;
    </script>
</head>
<body>
    <h1>Leaderboard</h1>
    <table id="Leaderboard"></table>

    <button onclick="displayLeaderboard()">Refresh Leaderboard</button>

    <h2>Add Score</h2>
    <form id="addScoreForm">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required>

        <label for="score">Score:</label>
        <input type="number" id="score" name="score" required>

        <button type="submit">Add Score</button>
    </form>

    <h3>Authentication Test</h3>
    <form>
    <label for="email">Email:</label>
    <input type="email" id="email" required>

    <label for="password">Password:</label>
    <input type="password" id="password" required>
    </form>

    <button onclick="signUp()">Sign Up</button>
    <button onclick="signIn()">Sign In</button>
    <button onclick="signOut()">Sign Out</button>

    <p id="userStatus">Not signed in</p>

</body>
</html>

